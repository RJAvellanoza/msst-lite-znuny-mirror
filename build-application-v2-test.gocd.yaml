# GoCD Pipeline for testing CI/CD v2 deployment automation
#
# This pipeline tests the deployment workflow before applying to production.
# Branch: feature/CICD_TEST_RJ
# Group: cicd-v2-test (separate from production pipelines)
#
# SECURITY NOTE:
# Environment variables (DEV_ZNUNY_HOST, REF_ZNUNY_HOST) must be configured
# as SECURE VARIABLES in GoCD UI, not in this file.
# Path: Admin → Environments → cicd-v2-test-env → Environment Variables (Secure)
#
# PIPELINE FLOW:
# build → preflight → deploy-dev → deploy-ref

format_version: 10

# Environment definition (variables configured in GoCD UI for security)
environments:
  cicd-v2-test-env:
    pipelines:
      - znuny-cicd-test-rj
    agents:
      - 0b27be5b-bae0-4e63-ba34-ea80929a1cba

pipelines:
  znuny-cicd-test-rj:
    group: cicd-v2-test
    label_template: "test-${COUNT}"

    materials:
      znuny-source:
        git: ssh://git@bitbucket.mot-solutions.com:7999/msstlite/msst-lite-znuny.git
        branch: feature/CICD_TEST_RJ
        destination: znuny-build
        auto_update: true

    stages:
      #──────────────────────────────────────────────────────────────
      # Stage 1: BUILD - Generate OPM package
      #──────────────────────────────────────────────────────────────
      - build:
          clean_workspace: true
          approval:
            type: manual
          jobs:
            build-and-package:
              timeout: 0
              artifacts:
                - build:
                    source: "**/*.opm"
                    destination: "pkg"
              tasks:
                - exec:
                    command: "bash"
                    arguments:
                      - "-c"
                      - |
                        echo "=== Build Info ==="
                        echo "Pipeline: ${GO_PIPELINE_NAME}"
                        echo "Build: ${GO_PIPELINE_COUNTER}"
                        echo "Branch: feature/CICD_TEST_RJ"
                        echo "Timestamp: $(date -Iseconds)"
                        echo "Agent: $(hostname)"
                        echo ""
                        echo "Checking for required build tools..."
                        perl -v

                - exec:
                    command: "/bin/sh"
                    arguments:
                      - "-c"
                      - |
                        ./znuny-build/gocd-build-application.sh /tmp/znuny-test-build-dir znuny-build

      #──────────────────────────────────────────────────────────────
      # Stage 2: PREFLIGHT - Validate deployment prerequisites
      #──────────────────────────────────────────────────────────────
      - preflight:
          approval:
            type: manual
            allow_only_on_success: true
          jobs:
            validate:
              tasks:
                - exec:
                    command: "/bin/bash"
                    arguments:
                      - "-c"
                      - |
                        set -e  # Fail fast on any error

                        echo "========================================"
                        echo "       PRE-FLIGHT CHECKS"
                        echo "========================================"
                        echo ""
                        echo "Timestamp: $(date -Iseconds)"
                        echo "Agent: $(hostname)"
                        echo ""

                        CHECKS_PASSED=0
                        CHECKS_WARNED=0

                        #────────────────────────────────────────────
                        # Check 1: SSH private key exists
                        #────────────────────────────────────────────
                        echo -n "[Check 1/4] SSH private key exists... "
                        if [ -f ~/.ssh/id_rsa ]; then
                          echo "PASS"
                          ((CHECKS_PASSED++))
                        elif [ -f ~/.ssh/id_ed25519 ]; then
                          echo "PASS (ed25519)"
                          ((CHECKS_PASSED++))
                        else
                          echo "FAIL"
                          echo ""
                          echo "ERROR: No SSH private key found"
                          echo "Expected: ~/.ssh/id_rsa or ~/.ssh/id_ed25519"
                          echo ""
                          echo "Resolution:"
                          echo "  1. Generate key: ssh-keygen -t rsa -b 4096"
                          echo "  2. Or copy existing key to ~/.ssh/"
                          exit 1
                        fi

                        #────────────────────────────────────────────
                        # Check 2: SSH key permissions
                        #────────────────────────────────────────────
                        echo -n "[Check 2/4] SSH key permissions... "
                        KEY_FILE=$(ls ~/.ssh/id_rsa 2>/dev/null || ls ~/.ssh/id_ed25519 2>/dev/null)
                        KEY_PERMS=$(stat -c %a "$KEY_FILE" 2>/dev/null || stat -f %Lp "$KEY_FILE" 2>/dev/null)
                        if [ "$KEY_PERMS" = "600" ]; then
                          echo "PASS (600)"
                          ((CHECKS_PASSED++))
                        else
                          echo "FAIL"
                          echo ""
                          echo "ERROR: SSH key permissions are $KEY_PERMS, expected 600"
                          echo ""
                          echo "Resolution:"
                          echo "  chmod 600 $KEY_FILE"
                          exit 1
                        fi

                        #────────────────────────────────────────────
                        # Check 3: SSH config exists (optional)
                        #────────────────────────────────────────────
                        echo -n "[Check 3/4] SSH config file... "
                        if [ -f ~/.ssh/config ]; then
                          echo "PASS"
                          ((CHECKS_PASSED++))
                        else
                          echo "WARN (optional)"
                          ((CHECKS_WARNED++))
                        fi

                        #────────────────────────────────────────────
                        # Check 4: Environment variables configured
                        #────────────────────────────────────────────
                        echo -n "[Check 4/4] Environment variables... "
                        ENV_OK=true

                        if [ -z "${DEV_ZNUNY_HOST}" ]; then
                          ENV_OK=false
                        fi

                        if [ "$ENV_OK" = "true" ]; then
                          echo "PASS"
                          ((CHECKS_PASSED++))
                          echo "           DEV_ZNUNY_HOST: configured"
                          if [ -n "${REF_ZNUNY_HOST}" ]; then
                            echo "           REF_ZNUNY_HOST: configured"
                          else
                            echo "           REF_ZNUNY_HOST: NOT configured (deploy-ref will skip)"
                            ((CHECKS_WARNED++))
                          fi
                        else
                          echo "FAIL"
                          echo ""
                          echo "ERROR: Required environment variables not configured"
                          echo ""
                          echo "Missing variables:"
                          [ -z "${DEV_ZNUNY_HOST}" ] && echo "  - DEV_ZNUNY_HOST"
                          echo ""
                          echo "Resolution:"
                          echo "  1. Go to GoCD UI: Admin → Environments → cicd-v2-test-env"
                          echo "  2. Add secure environment variables"
                          exit 1
                        fi

                        #────────────────────────────────────────────
                        # Summary
                        #────────────────────────────────────────────
                        echo ""
                        echo "========================================"
                        echo "       PRE-FLIGHT SUMMARY"
                        echo "========================================"
                        echo "Checks passed:  $CHECKS_PASSED"
                        echo "Warnings:       $CHECKS_WARNED"
                        echo ""
                        echo "All critical checks passed - ready for deployment"
                        echo "========================================"

      #──────────────────────────────────────────────────────────────
      # Stage 3: DEPLOY-DEV - Deploy to Development server
      #──────────────────────────────────────────────────────────────
      - deploy-dev:
          approval:
            type: manual
            allow_only_on_success: true
          jobs:
            deploy:
              tasks:
                - fetch:
                    stage: build
                    job: build-and-package
                    source: pkg/
                    destination: packages/
                - exec:
                    command: "/bin/bash"
                    arguments:
                      - "-c"
                      - |
                        set -e  # Fail fast on any error

                        echo "========================================"
                        echo "       DEPLOY TO DEV SERVER"
                        echo "========================================"
                        echo ""

                        #────────────────────────────────────────────
                        # Function: Check target host readiness
                        #────────────────────────────────────────────
                        check_target_host() {
                          local HOST=$1
                          local HOST_NAME=$2

                          echo "--- Target Host Checks: $HOST_NAME ---"
                          echo ""

                          # Check 1: Port reachable
                          echo -n "[Check 1/5] Port 2222 reachable... "
                          if timeout 5 bash -c "echo >/dev/tcp/$HOST/2222" 2>/dev/null; then
                            echo "PASS"
                          else
                            echo "FAIL"
                            echo ""
                            echo "ERROR: Cannot reach $HOST:2222"
                            echo ""
                            echo "Possible causes:"
                            echo "  - Host is down or unreachable"
                            echo "  - Firewall blocking port 2222"
                            echo "  - Port forwarding not configured on Proxmox"
                            echo ""
                            echo "Resolution:"
                            echo "  1. Check host is running: ping $HOST"
                            echo "  2. Check port forwarding: ssh root@$HOST 'iptables -t nat -L PREROUTING -n | grep 2222'"
                            return 1
                          fi

                          # Check 2: SSH authentication
                          echo -n "[Check 2/5] SSH public key auth... "
                          if ssh -p 2222 -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no root@$HOST "exit" 2>/dev/null; then
                            echo "PASS"
                          else
                            echo "FAIL"
                            echo ""
                            echo "ERROR: SSH public key authentication failed to $HOST"
                            echo ""
                            echo "Possible causes:"
                            echo "  - Public key not in /root/.ssh/authorized_keys on target"
                            echo "  - Key added to Proxmox host instead of container"
                            echo "  - PubkeyAuthentication not enabled in sshd_config"
                            echo ""
                            echo "Resolution:"
                            echo "  1. Add this key to /root/.ssh/authorized_keys INSIDE the container:"
                            cat ~/.ssh/id_rsa.pub 2>/dev/null || cat ~/.ssh/id_ed25519.pub 2>/dev/null
                            echo ""
                            echo "  2. Ensure PubkeyAuthentication yes in /etc/ssh/sshd_config"
                            echo "  3. Restart sshd: systemctl restart sshd"
                            return 1
                          fi

                          # Check 3: /tmp writable
                          echo -n "[Check 3/5] /tmp writable... "
                          if ssh -p 2222 -o StrictHostKeyChecking=no root@$HOST "touch /tmp/.gocd_deploy_test && rm /tmp/.gocd_deploy_test" 2>/dev/null; then
                            echo "PASS"
                          else
                            echo "FAIL"
                            echo ""
                            echo "ERROR: Cannot write to /tmp on $HOST"
                            return 1
                          fi

                          # Check 4: Disk space (500MB minimum)
                          echo -n "[Check 4/5] Disk space (min 500MB)... "
                          AVAIL_KB=$(ssh -p 2222 -o StrictHostKeyChecking=no root@$HOST "df /tmp | tail -1 | awk '{print \$4}'" 2>/dev/null)
                          AVAIL_MB=$((AVAIL_KB / 1024))
                          if [ "$AVAIL_MB" -ge 500 ]; then
                            echo "PASS (${AVAIL_MB}MB available)"
                          else
                            echo "FAIL"
                            echo ""
                            echo "ERROR: Only ${AVAIL_MB}MB available on /tmp, need 500MB"
                            echo ""
                            echo "Resolution:"
                            echo "  1. Clean up /tmp: ssh -p 2222 root@$HOST 'rm -rf /tmp/*'"
                            echo "  2. Or expand disk"
                            return 1
                          fi

                          # Check 5: Cleanup old OPM files
                          echo -n "[Check 5/5] Cleanup old deployments... "
                          ssh -p 2222 -o StrictHostKeyChecking=no root@$HOST "rm -f /tmp/MSSTLite-*.opm" 2>/dev/null
                          echo "DONE"

                          echo ""
                          echo "--- All target checks passed ---"
                          echo ""
                          return 0
                        }

                        #────────────────────────────────────────────
                        # Main deployment logic
                        #────────────────────────────────────────────

                        DEV_HOST="${DEV_ZNUNY_HOST:-NOT_CONFIGURED}"

                        if [ "$DEV_HOST" = "NOT_CONFIGURED" ]; then
                          echo "ERROR: DEV_ZNUNY_HOST not configured"
                          echo "This should have been caught by preflight stage"
                          exit 1
                        fi

                        echo "Target: $DEV_HOST"
                        echo ""

                        # Run target host checks
                        check_target_host "$DEV_HOST" "DEV"

                        # Find the OPM file
                        echo "--- Locating OPM Package ---"
                        echo ""
                        OPM_FILE=$(ls packages/pkg/MSSTLite-*.opm 2>/dev/null | head -1)
                        if [ -z "$OPM_FILE" ]; then
                          echo "ERROR: No MSSTLite OPM file found in packages/pkg/"
                          echo ""
                          echo "Contents of packages/pkg/:"
                          ls -la packages/pkg/ 2>/dev/null || echo "  (directory not found)"
                          exit 1
                        fi
                        echo "Found: $OPM_FILE"
                        echo "Size:  $(du -h "$OPM_FILE" | cut -f1)"
                        echo ""

                        # Deploy the OPM file
                        echo "--- Deploying OPM Package ---"
                        echo ""
                        echo "Copying $OPM_FILE to $DEV_HOST:/tmp/"
                        scp -P 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$OPM_FILE" root@${DEV_HOST}:/tmp/

                        # Verify deployment
                        echo ""
                        echo "--- Verification ---"
                        ssh -p 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@${DEV_HOST} << 'REMOTE'
                          echo ""
                          echo "OPM file on DEV server:"
                          ls -la /tmp/MSSTLite-*.opm
                          echo ""
                          echo "MD5 checksum:"
                          md5sum /tmp/MSSTLite-*.opm
                        REMOTE

                        echo ""
                        echo "========================================"
                        echo "       DEV DEPLOYMENT SUCCESSFUL"
                        echo "========================================"

      #──────────────────────────────────────────────────────────────
      # Stage 4: DEPLOY-REF - Deploy to Reference server
      #──────────────────────────────────────────────────────────────
      - deploy-ref:
          approval:
            type: manual
            allow_only_on_success: true
          jobs:
            deploy:
              tasks:
                - fetch:
                    stage: build
                    job: build-and-package
                    source: pkg/
                    destination: packages/
                - exec:
                    command: "/bin/bash"
                    arguments:
                      - "-c"
                      - |
                        set -e  # Fail fast on any error

                        echo "========================================"
                        echo "       DEPLOY TO REF SERVER"
                        echo "========================================"
                        echo ""

                        #────────────────────────────────────────────
                        # Function: Check target host readiness
                        #────────────────────────────────────────────
                        check_target_host() {
                          local HOST=$1
                          local HOST_NAME=$2

                          echo "--- Target Host Checks: $HOST_NAME ---"
                          echo ""

                          # Check 1: Port reachable
                          echo -n "[Check 1/5] Port 2222 reachable... "
                          if timeout 5 bash -c "echo >/dev/tcp/$HOST/2222" 2>/dev/null; then
                            echo "PASS"
                          else
                            echo "FAIL"
                            echo ""
                            echo "ERROR: Cannot reach $HOST:2222"
                            echo ""
                            echo "Possible causes:"
                            echo "  - Host is down or unreachable"
                            echo "  - Firewall blocking port 2222"
                            echo "  - Port forwarding not configured on Proxmox"
                            echo ""
                            echo "Resolution:"
                            echo "  1. Check host is running: ping $HOST"
                            echo "  2. Check port forwarding: ssh root@$HOST 'iptables -t nat -L PREROUTING -n | grep 2222'"
                            return 1
                          fi

                          # Check 2: SSH authentication
                          echo -n "[Check 2/5] SSH public key auth... "
                          if ssh -p 2222 -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no root@$HOST "exit" 2>/dev/null; then
                            echo "PASS"
                          else
                            echo "FAIL"
                            echo ""
                            echo "ERROR: SSH public key authentication failed to $HOST"
                            echo ""
                            echo "Possible causes:"
                            echo "  - Public key not in /root/.ssh/authorized_keys on target"
                            echo "  - Key added to Proxmox host instead of container"
                            echo "  - PubkeyAuthentication not enabled in sshd_config"
                            echo ""
                            echo "Resolution:"
                            echo "  1. Add this key to /root/.ssh/authorized_keys INSIDE the container:"
                            cat ~/.ssh/id_rsa.pub 2>/dev/null || cat ~/.ssh/id_ed25519.pub 2>/dev/null
                            echo ""
                            echo "  2. Ensure PubkeyAuthentication yes in /etc/ssh/sshd_config"
                            echo "  3. Restart sshd: systemctl restart sshd"
                            return 1
                          fi

                          # Check 3: /tmp writable
                          echo -n "[Check 3/5] /tmp writable... "
                          if ssh -p 2222 -o StrictHostKeyChecking=no root@$HOST "touch /tmp/.gocd_deploy_test && rm /tmp/.gocd_deploy_test" 2>/dev/null; then
                            echo "PASS"
                          else
                            echo "FAIL"
                            echo ""
                            echo "ERROR: Cannot write to /tmp on $HOST"
                            return 1
                          fi

                          # Check 4: Disk space (500MB minimum)
                          echo -n "[Check 4/5] Disk space (min 500MB)... "
                          AVAIL_KB=$(ssh -p 2222 -o StrictHostKeyChecking=no root@$HOST "df /tmp | tail -1 | awk '{print \$4}'" 2>/dev/null)
                          AVAIL_MB=$((AVAIL_KB / 1024))
                          if [ "$AVAIL_MB" -ge 500 ]; then
                            echo "PASS (${AVAIL_MB}MB available)"
                          else
                            echo "FAIL"
                            echo ""
                            echo "ERROR: Only ${AVAIL_MB}MB available on /tmp, need 500MB"
                            echo ""
                            echo "Resolution:"
                            echo "  1. Clean up /tmp: ssh -p 2222 root@$HOST 'rm -rf /tmp/*'"
                            echo "  2. Or expand disk"
                            return 1
                          fi

                          # Check 5: Cleanup old OPM files
                          echo -n "[Check 5/5] Cleanup old deployments... "
                          ssh -p 2222 -o StrictHostKeyChecking=no root@$HOST "rm -f /tmp/MSSTLite-*.opm" 2>/dev/null
                          echo "DONE"

                          echo ""
                          echo "--- All target checks passed ---"
                          echo ""
                          return 0
                        }

                        #────────────────────────────────────────────
                        # Main deployment logic
                        #────────────────────────────────────────────

                        REF_HOST="${REF_ZNUNY_HOST:-NOT_CONFIGURED}"

                        if [ "$REF_HOST" = "NOT_CONFIGURED" ]; then
                          echo "WARNING: REF_ZNUNY_HOST not configured"
                          echo "Skipping REF deployment"
                          echo ""
                          echo "To enable REF deployment:"
                          echo "  1. Go to GoCD UI: Admin → Environments → cicd-v2-test-env"
                          echo "  2. Add REF_ZNUNY_HOST as secure environment variable"
                          exit 0
                        fi

                        echo "Target: $REF_HOST"
                        echo ""

                        # Run target host checks
                        check_target_host "$REF_HOST" "REF"

                        # Find the OPM file
                        echo "--- Locating OPM Package ---"
                        echo ""
                        OPM_FILE=$(ls packages/pkg/MSSTLite-*.opm 2>/dev/null | head -1)
                        if [ -z "$OPM_FILE" ]; then
                          echo "ERROR: No MSSTLite OPM file found in packages/pkg/"
                          echo ""
                          echo "Contents of packages/pkg/:"
                          ls -la packages/pkg/ 2>/dev/null || echo "  (directory not found)"
                          exit 1
                        fi
                        echo "Found: $OPM_FILE"
                        echo "Size:  $(du -h "$OPM_FILE" | cut -f1)"
                        echo ""

                        # Deploy the OPM file
                        echo "--- Deploying OPM Package ---"
                        echo ""
                        echo "Copying $OPM_FILE to $REF_HOST:/tmp/"
                        scp -P 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$OPM_FILE" root@${REF_HOST}:/tmp/

                        # Verify deployment
                        echo ""
                        echo "--- Verification ---"
                        ssh -p 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@${REF_HOST} << 'REMOTE'
                          echo ""
                          echo "OPM file on REF server:"
                          ls -la /tmp/MSSTLite-*.opm
                          echo ""
                          echo "MD5 checksum:"
                          md5sum /tmp/MSSTLite-*.opm
                        REMOTE

                        echo ""
                        echo "========================================"
                        echo "       REF DEPLOYMENT SUCCESSFUL"
                        echo "========================================"
