# GoCD Pipeline for testing CI/CD v2 deployment automation
#
# This pipeline tests the deployment workflow before applying to production.
# Branch: feature/CICD_TEST_RJ
# Group: cicd-v2-test (separate from production pipelines)
#
# SECURITY NOTE:
# Environment variables (DEV_ZNUNY_HOST, REF_ZNUNY_HOST) must be configured
# as SECURE VARIABLES in GoCD UI, not in this file.
# Path: Admin → Environments → cicd-v2-test-env → Environment Variables (Secure)

format_version: 10

# Environment definition (variables configured in GoCD UI for security)
environments:
  cicd-v2-test-env:
    pipelines:
      - znuny-cicd-test-rj
    agents:
      - 0b27be5b-bae0-4e63-ba34-ea80929a1cba

pipelines:
  znuny-cicd-test-rj:
    group: cicd-v2-test
    label_template: "test-${COUNT}"

    materials:
      znuny-source:
        git: ssh://git@bitbucket.mot-solutions.com:7999/msstlite/msst-lite-znuny.git
        branch: feature/CICD_TEST_RJ
        destination: znuny-build
        auto_update: true

    stages:
      #──────────────────────────────────────────────────────────────
      # Stage 1: BUILD - Generate OPM package
      #──────────────────────────────────────────────────────────────
      - build:
          clean_workspace: true
          approval:
            type: manual
          jobs:
            build-and-package:
              timeout: 0
              artifacts:
                - build:
                    source: "**/*.opm"
                    destination: "pkg"
              tasks:
                - exec:
                    command: "bash"
                    arguments:
                      - "-c"
                      - |
                        echo "=== Build Info ==="
                        echo "Pipeline: ${GO_PIPELINE_NAME}"
                        echo "Build: ${GO_PIPELINE_COUNTER}"
                        echo "Branch: feature/CICD_TEST_RJ"
                        echo "Timestamp: $(date -Iseconds)"
                        echo "Agent: $(hostname)"
                        echo ""
                        echo "Checking for required build tools..."
                        perl -v

                - exec:
                    command: "/bin/sh"
                    arguments:
                      - "-c"
                      - |
                        ./znuny-build/gocd-build-application.sh /tmp/znuny-test-build-dir znuny-build

      #──────────────────────────────────────────────────────────────
      # Stage 2: DEPLOY-DEV - Deploy to Development server
      #──────────────────────────────────────────────────────────────
      - deploy-dev:
          approval:
            type: manual
            allow_only_on_success: true
          jobs:
            deploy:
              tasks:
                - fetch:
                    stage: build
                    job: build-and-package
                    source: pkg/
                    destination: packages/
                - exec:
                    command: "/bin/bash"
                    arguments:
                      - "-c"
                      - |
                        echo "=== Deploy to DEV Server ==="
                        echo ""
                        echo "Build artifacts:"
                        ls -la packages/pkg/ || echo "No packages found"
                        echo ""

                        ## Show SSH public key for setup
                        echo "=== GoCD Agent SSH Public Key ==="
                        echo "Add this key to /root/.ssh/authorized_keys on DEV and REF servers:"
                        echo ""
                        cat ~/.ssh/id_ed25519.pub 2>/dev/null || cat ~/.ssh/id_rsa.pub 2>/dev/null || echo "No SSH key found"
                        echo ""
                        echo "================================="
                        echo ""

                        ## === SAFE TEST: Deploy OPM file to verify connectivity ===
                        DEV_HOST="${DEV_ZNUNY_HOST:-NOT_CONFIGURED}"

                        if [ "$DEV_HOST" = "NOT_CONFIGURED" ]; then
                          echo "WARNING: DEV_ZNUNY_HOST not configured"
                          echo "Skipping actual deployment"
                          echo ""
                          echo "To enable deployment, set environment variable:"
                          echo "  DEV_ZNUNY_HOST=<ip-or-hostname>"
                          exit 0
                        fi

                        echo "Deploying OPM package to: $DEV_HOST"

                        ## Find the MSSTLite OPM file
                        OPM_FILE=$(ls packages/pkg/MSSTLite-*.opm 2>/dev/null | head -1)
                        if [ -z "$OPM_FILE" ]; then
                          echo "ERROR: No MSSTLite OPM file found"
                          exit 1
                        fi
                        echo "Found: $OPM_FILE"

                        ## Deploy OPM file to verify SSH connectivity
                        scp -P 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$OPM_FILE" root@${DEV_HOST}:/tmp/

                        ## Verify file was deployed
                        ssh -p 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@${DEV_HOST} << 'REMOTE'
                          echo "=== Verification on DEV Server ==="
                          echo "OPM file deployed successfully:"
                          ls -la /tmp/MSSTLite-*.opm
                          echo ""
                          echo "Deployment test PASSED"
                        REMOTE

      #──────────────────────────────────────────────────────────────
      # Stage 3: DEPLOY-REF - Deploy to Reference server
      #──────────────────────────────────────────────────────────────
      - deploy-ref:
          approval:
            type: manual
            allow_only_on_success: true
          jobs:
            deploy:
              tasks:
                - fetch:
                    stage: build
                    job: build-and-package
                    source: pkg/
                    destination: packages/
                - exec:
                    command: "/bin/bash"
                    arguments:
                      - "-c"
                      - |
                        echo "=== Deploy to REF Server ==="
                        echo ""
                        echo "Build artifacts:"
                        ls -la packages/pkg/ || echo "No packages found"
                        echo ""

                        ## === SAFE TEST: Deploy OPM file to verify connectivity ===
                        REF_HOST="${REF_ZNUNY_HOST:-NOT_CONFIGURED}"

                        if [ "$REF_HOST" = "NOT_CONFIGURED" ]; then
                          echo "WARNING: REF_ZNUNY_HOST not configured"
                          echo "Skipping actual deployment"
                          echo ""
                          echo "To enable deployment, set environment variable:"
                          echo "  REF_ZNUNY_HOST=<ip-or-hostname>"
                          exit 0
                        fi

                        echo "Deploying OPM package to: $REF_HOST"

                        ## Find the MSSTLite OPM file
                        OPM_FILE=$(ls packages/pkg/MSSTLite-*.opm 2>/dev/null | head -1)
                        if [ -z "$OPM_FILE" ]; then
                          echo "ERROR: No MSSTLite OPM file found"
                          exit 1
                        fi
                        echo "Found: $OPM_FILE"

                        ## Deploy OPM file to verify SSH connectivity
                        scp -P 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$OPM_FILE" root@${REF_HOST}:/tmp/

                        ## Verify file was deployed
                        ssh -p 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@${REF_HOST} << 'REMOTE'
                          echo "=== Verification on REF Server ==="
                          echo "OPM file deployed successfully:"
                          ls -la /tmp/MSSTLite-*.opm
                          echo ""
                          echo "Deployment test PASSED"
                        REMOTE
