# --
# Copyright (C) 2025 MSST, https://msst.com/
# --
# This software comes with ABSOLUTELY NO WARRANTY.
# --

<div class="MainBox ARIARoleMain LayoutFixedSidebar SidebarFirst">

    <!-- Side Navigation (Shared) -->
    [% INCLUDE "AgentOperationalReportsSidebar.tt" ActiveSidebar = 'AverageBacklog' %]

    <div class="ContentColumn">

        <!-- Section 1: Active Tickets Average Backlog -->
        <div class="WidgetSimple">
            <div class="Header">
                <h2>[% Translate("Active Tickets Average Backlog") | html %]</h2>
            </div>
            <div class="Content">

                <!-- Charts with Legend on right -->
                <div style="display: flex; gap: 20px;">
                    <!-- 4 Charts - 2x2 grid -->
                    <div style="flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <!-- P1 Chart -->
                        <div style="border: 1px solid #dee2e6; padding: 15px; text-align: center; border-radius: 4px;">
                            <h3 style="margin-top: 0;">P1</h3>
                            <svg id="backlogChartP1"></svg>
                        </div>

                        <!-- P2 Chart -->
                        <div style="border: 1px solid #dee2e6; padding: 15px; text-align: center; border-radius: 4px;">
                            <h3 style="margin-top: 0;">P2</h3>
                            <svg id="backlogChartP2"></svg>
                        </div>

                        <!-- P3 Chart -->
                        <div style="border: 1px solid #dee2e6; padding: 15px; text-align: center; border-radius: 4px;">
                            <h3 style="margin-top: 0;">P3</h3>
                            <svg id="backlogChartP3"></svg>
                        </div>

                        <!-- P4 Chart -->
                        <div style="border: 1px solid #dee2e6; padding: 15px; text-align: center; border-radius: 4px;">
                            <h3 style="margin-top: 0;">P4</h3>
                            <svg id="backlogChartP4"></svg>
                        </div>
                    </div>

                    <!-- Right: Color Code Legend -->
                    <div style="flex: 0 0 180px;">
                        <h4 style="margin-top: 0;">[% Translate("Legend") | html %]</h4>
                        <div style="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
                            <div>
                                <div style="display: inline-block; width: 20px; height: 20px; background: #4285F4; margin-right: 8px; vertical-align: middle;"></div>
                                <span>[% Translate("Active") | html %]</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Section 2: Breakdown -->
        <div class="WidgetSimple" style="margin-top: 20px;">
            <div class="Header">
                <h2>[% Translate("Breakdown") | html %]</h2>
            </div>
            <div class="Content">
                <table class="DataTable" style="width: auto; min-width: 500px;">
                    <thead>
                        <tr>
                            <th style="background: #f8f9fa; padding: 12px; text-align: left;">[% Translate("Ticket State") | html %]</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: center;">P1</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: center;">P2</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: center;">P3</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: center;">P4</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: center;">[% Translate("AVG") | html %]</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 10px 12px;">[% Translate("Average Backlog (Days)") | html %]</td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateIDs=[% Data.OpenStateIDs %];PriorityIDs=[% Data.ByPriority.item('P1-Critical').PriorityID %];Source=AgentAverageBacklog" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P1-Critical').AvgDays || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateIDs=[% Data.OpenStateIDs %];PriorityIDs=[% Data.ByPriority.item('P2-High').PriorityID %];Source=AgentAverageBacklog" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P2-High').AvgDays || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateIDs=[% Data.OpenStateIDs %];PriorityIDs=[% Data.ByPriority.item('P3-Medium').PriorityID %];Source=AgentAverageBacklog" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P3-Medium').AvgDays || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateIDs=[% Data.OpenStateIDs %];PriorityIDs=[% Data.ByPriority.item('P4-Low').PriorityID %];Source=AgentAverageBacklog" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P4-Low').AvgDays || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                [% Data.AvgBacklogDays || 0 %]
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 10px 12px;">[% Translate("Ticket Count") | html %]</td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateIDs=[% Data.OpenStateIDs %];PriorityIDs=[% Data.ByPriority.item('P1-Critical').PriorityID %];Source=AgentAverageBacklog" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P1-Critical').Count || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateIDs=[% Data.OpenStateIDs %];PriorityIDs=[% Data.ByPriority.item('P2-High').PriorityID %];Source=AgentAverageBacklog" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P2-High').Count || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateIDs=[% Data.OpenStateIDs %];PriorityIDs=[% Data.ByPriority.item('P3-Medium').PriorityID %];Source=AgentAverageBacklog" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P3-Medium').Count || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateIDs=[% Data.OpenStateIDs %];PriorityIDs=[% Data.ByPriority.item('P4-Low').PriorityID %];Source=AgentAverageBacklog" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P4-Low').Count || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                [% Data.AvgTicketCount || 0 %]
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<!-- D3.js Library -->
<script src="[% Config("Frontend::WebPath") %]js/thirdparty/d3-3.5.7/d3.min.js"></script>
<script type="text/javascript">
(function() {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initBacklogCharts);
    } else {
        initBacklogCharts();
    }

    function initBacklogCharts() {
        var chartData = {
            'P1-Critical': { avgDays: [% Data.ByPriority.item('P1-Critical').AvgDays || 0 %] },
            'P2-High': { avgDays: [% Data.ByPriority.item('P2-High').AvgDays || 0 %] },
            'P3-Medium': { avgDays: [% Data.ByPriority.item('P3-Medium').AvgDays || 0 %] },
            'P4-Low': { avgDays: [% Data.ByPriority.item('P4-Low').AvgDays || 0 %] }
        };

        var charts = {
            'P1-Critical': 'backlogChartP1',
            'P2-High': 'backlogChartP2',
            'P3-Medium': 'backlogChartP3',
            'P4-Low': 'backlogChartP4'
        };

        Object.keys(charts).forEach(function(priority) {
            var canvasId = charts[priority];
            var data = chartData[priority];
            createBacklogChart(canvasId, data.avgDays);
        });
    }

    function createBacklogChart(canvasId, avgDays) {
        var width = 180;
        var height = 180;
        var radius = Math.min(width, height) / 2;

        var svg = d3.select('#' + canvasId)
            .attr('width', width)
            .attr('height', height)
            .append('g')
            .attr('transform', 'translate(' + (width / 2) + ',' + (height / 2) + ')');

        // Create a single solid circle
        var arc = d3.svg.arc()
            .outerRadius(radius - 10)
            .innerRadius(0);

        var pie = d3.layout.pie()
            .sort(null)
            .value(function(d) { return d.value; });

        var pieData = [{ value: 1, color: '#4285F4' }];

        var g = svg.selectAll('.arc')
            .data(pie(pieData))
            .enter().append('g')
            .attr('class', 'arc');

        g.append('path')
            .attr('d', arc)
            .style('fill', function(d) { return d.data.color; });

        // Add centered text showing avg days
        svg.append('text')
            .attr('text-anchor', 'middle')
            .attr('dy', '.35em')
            .style('fill', 'white')
            .style('font-size', '28px')
            .style('font-weight', 'bold')
            .text(avgDays);
    }
})();
</script>
