# --
# Copyright (C) 2025 MSST, https://msst.com/
# --
# This software comes with ABSOLUTELY NO WARRANTY.
# --

<div class="MainBox ARIARoleMain LayoutFixedSidebar SidebarFirst">

    <!-- Side Navigation (Shared) -->
    [% INCLUDE "AgentOperationalReportsSidebar.tt" ActiveSidebar = 'AllActiveTickets' %]

    <div class="ContentColumn">

        <!-- Section 1: Active Tickets Assignment Report -->
        <div class="WidgetSimple">
            <div class="Header">
                <h2>[% Translate("Active Tickets Assignment Report") | html %]</h2>
            </div>
            <div class="Content">

                <!-- Charts with Legend on right -->
                <div style="display: flex; gap: 20px;">
                    <!-- 4 Pie Charts - 2x2 grid -->
                    <div style="flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <!-- P1 Chart -->
                        <div style="border: 1px solid #dee2e6; padding: 15px; text-align: center; border-radius: 4px;">
                            <h3 style="margin-top: 0;">P1</h3>
                            <svg id="chartP1Critical"></svg>
                        </div>

                        <!-- P2 Chart -->
                        <div style="border: 1px solid #dee2e6; padding: 15px; text-align: center; border-radius: 4px;">
                            <h3 style="margin-top: 0;">P2</h3>
                            <svg id="chartP2High"></svg>
                        </div>

                        <!-- P3 Chart -->
                        <div style="border: 1px solid #dee2e6; padding: 15px; text-align: center; border-radius: 4px;">
                            <h3 style="margin-top: 0;">P3</h3>
                            <svg id="chartP3Medium"></svg>
                        </div>

                        <!-- P4 Chart -->
                        <div style="border: 1px solid #dee2e6; padding: 15px; text-align: center; border-radius: 4px;">
                            <h3 style="margin-top: 0;">P4</h3>
                            <svg id="chartP4Low"></svg>
                        </div>
                    </div>

                    <!-- Right: Color Code Legend -->
                    <div style="flex: 0 0 180px;">
                        <h4 style="margin-top: 0;">[% Translate("Legend") | html %]</h4>
                        <div style="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
                            <div style="margin-bottom: 10px;">
                                <div style="display: inline-block; width: 20px; height: 20px; background: #4285F4; margin-right: 8px; vertical-align: middle;"></div>
                                <span>[% Translate("Assigned") | html %]</span>
                            </div>
                            <div>
                                <div style="display: inline-block; width: 20px; height: 20px; background: #EA4335; margin-right: 8px; vertical-align: middle;"></div>
                                <span>[% Translate("Unassigned") | html %]</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Section 2: Breakdown -->
        <div class="WidgetSimple" style="margin-top: 20px;">
            <div class="Header">
                <h2>[% Translate("Breakdown") | html %]</h2>
            </div>
            <div class="Content">
                <table class="DataTable" style="width: auto; min-width: 500px;">
                    <thead>
                        <tr>
                            <th style="background: #f8f9fa; padding: 12px; text-align: left;">[% Translate("Assignee State") | html %]</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: center;">P1</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: center;">P2</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: center;">P3</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: center;">P4</th>
                            <th style="background: #f8f9fa; padding: 12px; text-align: center;">[% Translate("Total") | html %]</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 10px 12px;">[% Translate("Assigned") | html %]</td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateType=Open;Priorities=P1-Critical;AssignedOnly=1;Source=AgentActiveTicketsAssignment" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P1-Critical').Assigned || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateType=Open;Priorities=P2-High;AssignedOnly=1;Source=AgentActiveTicketsAssignment" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P2-High').Assigned || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateType=Open;Priorities=P3-Medium;AssignedOnly=1;Source=AgentActiveTicketsAssignment" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P3-Medium').Assigned || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateType=Open;Priorities=P4-Low;AssignedOnly=1;Source=AgentActiveTicketsAssignment" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P4-Low').Assigned || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateType=Open;AssignedOnly=1;Source=AgentActiveTicketsAssignment" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P1-Critical').Assigned + Data.ByPriority.item('P2-High').Assigned + Data.ByPriority.item('P3-Medium').Assigned + Data.ByPriority.item('P4-Low').Assigned %]</a>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 10px 12px;">[% Translate("Unassigned") | html %]</td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateType=Open;Priorities=P1-Critical;OwnerIDs=99;Source=AgentActiveTicketsAssignment" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P1-Critical').Unassigned || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateType=Open;Priorities=P2-High;OwnerIDs=99;Source=AgentActiveTicketsAssignment" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P2-High').Unassigned || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateType=Open;Priorities=P3-Medium;OwnerIDs=99;Source=AgentActiveTicketsAssignment" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P3-Medium').Unassigned || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateType=Open;Priorities=P4-Low;OwnerIDs=99;Source=AgentActiveTicketsAssignment" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P4-Low').Unassigned || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateType=Open;OwnerIDs=99;Source=AgentActiveTicketsAssignment" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P1-Critical').Unassigned + Data.ByPriority.item('P2-High').Unassigned + Data.ByPriority.item('P3-Medium').Unassigned + Data.ByPriority.item('P4-Low').Unassigned %]</a>
                            </td>
                        </tr>
                        <tr style="font-weight: bold; border-top: 2px solid #dee2e6;">
                            <td style="padding: 10px 12px;">[% Translate("Grand Total") | html %]</td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateType=Open;Priorities=P1-Critical;Source=AgentActiveTicketsAssignment" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P1-Critical').Total || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateType=Open;Priorities=P2-High;Source=AgentActiveTicketsAssignment" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P2-High').Total || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateType=Open;Priorities=P3-Medium;Source=AgentActiveTicketsAssignment" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P3-Medium').Total || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateType=Open;Priorities=P4-Low;Source=AgentActiveTicketsAssignment" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P4-Low').Total || 0 %]</a>
                            </td>
                            <td style="padding: 10px 12px; text-align: center;">
                                <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateType=Open;Source=AgentActiveTicketsAssignment" style="color: #007bff; text-decoration: none;">[% Data.ByPriority.item('P1-Critical').Total + Data.ByPriority.item('P2-High').Total + Data.ByPriority.item('P3-Medium').Total + Data.ByPriority.item('P4-Low').Total %]</a>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <p style="margin-top: 15px; font-size: 12px;">
                    <a href="[% Env("Baselink") %]Action=AgentReportTickets;StateType=Open;OwnerIDs=99;Source=AgentActiveTicketsAssignment" style="color: #EA4335; text-decoration: underline;">
                        [% Translate("View All Unassigned Incidents") | html %]
                    </a>
                </p>
            </div>
        </div>

    </div>
</div>

<!-- D3.js Library -->
<script src="[% Config("Frontend::WebPath") %]js/thirdparty/d3-3.5.7/d3.min.js"></script>
<script type="text/javascript">
(function() {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCharts);
    } else {
        initCharts();
    }

    function initCharts() {
        var chartData = {
            'P1-Critical': {
                assigned: [% Data.ByPriority.item('P1-Critical').Assigned || 0 %],
                unassigned: [% Data.ByPriority.item('P1-Critical').Unassigned || 0 %],
                assignedPct: [% Data.ByPriority.item('P1-Critical').AssignedPct || 0 %],
                unassignedPct: [% Data.ByPriority.item('P1-Critical').UnassignedPct || 0 %]
            },
            'P2-High': {
                assigned: [% Data.ByPriority.item('P2-High').Assigned || 0 %],
                unassigned: [% Data.ByPriority.item('P2-High').Unassigned || 0 %],
                assignedPct: [% Data.ByPriority.item('P2-High').AssignedPct || 0 %],
                unassignedPct: [% Data.ByPriority.item('P2-High').UnassignedPct || 0 %]
            },
            'P3-Medium': {
                assigned: [% Data.ByPriority.item('P3-Medium').Assigned || 0 %],
                unassigned: [% Data.ByPriority.item('P3-Medium').Unassigned || 0 %],
                assignedPct: [% Data.ByPriority.item('P3-Medium').AssignedPct || 0 %],
                unassignedPct: [% Data.ByPriority.item('P3-Medium').UnassignedPct || 0 %]
            },
            'P4-Low': {
                assigned: [% Data.ByPriority.item('P4-Low').Assigned || 0 %],
                unassigned: [% Data.ByPriority.item('P4-Low').Unassigned || 0 %],
                assignedPct: [% Data.ByPriority.item('P4-Low').AssignedPct || 0 %],
                unassignedPct: [% Data.ByPriority.item('P4-Low').UnassignedPct || 0 %]
            }
        };

        var prioritySearchNames = {
            'P1-Critical': 'P1-Critical',
            'P2-High': 'P2-High',
            'P3-Medium': 'P3-Medium',
            'P4-Low': 'P4-Low'
        };

        var charts = {
            'P1-Critical': 'chartP1Critical',
            'P2-High': 'chartP2High',
            'P3-Medium': 'chartP3Medium',
            'P4-Low': 'chartP4Low'
        };

        Object.keys(charts).forEach(function(priority) {
            var canvasId = charts[priority];
            var data = chartData[priority];

            if (data.assigned === 0 && data.unassigned === 0) {
                d3.select('#' + canvasId).append('text')
                    .attr('x', 90)
                    .attr('y', 90)
                    .attr('text-anchor', 'middle')
                    .style('font-size', '14px')
                    .text('No Data');
                return;
            }

            createPieChart(canvasId, data, priority, prioritySearchNames[priority]);
        });
    }

    function createPieChart(canvasId, data, priorityName, prioritySearchValue) {
        var width = 180;
        var height = 180;
        var radius = Math.min(width, height) / 2;

        var svg = d3.select('#' + canvasId)
            .attr('width', width)
            .attr('height', height)
            .append('g')
            .attr('transform', 'translate(' + (width / 2) + ',' + (height / 2) + ')');

        var pieData = [
            { label: 'Assigned', value: data.assigned, color: '#4285F4', pct: data.assignedPct },
            { label: 'Unassigned', value: data.unassigned, color: '#EA4335', pct: data.unassignedPct }
        ];

        var arc = d3.svg.arc()
            .outerRadius(radius - 10)
            .innerRadius(0);

        var pie = d3.layout.pie()
            .sort(null)
            .value(function(d) { return d.value; });

        var g = svg.selectAll('.arc')
            .data(pie(pieData))
            .enter().append('g')
            .attr('class', 'arc');

        g.append('path')
            .attr('d', arc)
            .style('fill', function(d) { return d.data.color; });

        g.append('text')
            .attr('transform', function(d) { return 'translate(' + arc.centroid(d) + ')'; })
            .attr('dy', '-0.2em')
            .style('text-anchor', 'middle')
            .style('fill', 'white')
            .style('font-size', '14px')
            .style('font-weight', 'bold')
            .text(function(d) { return d.data.value > 0 ? d.data.value : ''; });

        g.append('text')
            .attr('transform', function(d) { return 'translate(' + arc.centroid(d) + ')'; })
            .attr('dy', '1em')
            .style('text-anchor', 'middle')
            .style('fill', 'white')
            .style('font-size', '11px')
            .style('font-weight', 'bold')
            .text(function(d) { return d.data.pct > 5 ? '(' + d.data.pct + '%)' : ''; });
    }
})();
</script>
