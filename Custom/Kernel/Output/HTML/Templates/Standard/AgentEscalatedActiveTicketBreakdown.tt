# --
# Copyright (C) 2025 MSST, https://msst.com/
# --
# This software comes with ABSOLUTELY NO WARRANTY.
# --

<div class="MainBox ARIARoleMain LayoutFixedSidebar SidebarFirst">

    <!-- Side Navigation (Shared) -->
    [% INCLUDE "AgentEscalationReportsSidebar.tt" ActiveSidebar = 'EscalatedActiveTicketBreakdown' %]

    <div class="ContentColumn">
        <div class="WidgetSimple">
            <div class="Header">
                <h2>[% Translate("Escalated Active Tickets") | html %]</h2>
            </div>
            <div class="Content">

                <!-- Tab Navigation -->
                <style>
                    #EscalatedActiveTicketTabs {
                        list-style: none;
                        margin: 0;
                        padding: 0;
                        border-bottom: 2px solid #ddd;
                        display: flex;
                        gap: 0;
                    }
                    #EscalatedActiveTicketTabs li {
                        margin: 0;
                        padding: 0;
                    }
                    #EscalatedActiveTicketTabs li a {
                        display: block;
                        padding: 12px 24px;
                        background: #f5f5f5;
                        border: 1px solid #ddd;
                        border-bottom: none;
                        margin-right: -1px;
                        color: #333;
                        text-decoration: none;
                        font-weight: 500;
                        transition: all 0.2s;
                    }
                    #EscalatedActiveTicketTabs li a:hover {
                        background: #e9e9e9;
                        color: #000;
                    }
                    #EscalatedActiveTicketTabs li.Active a {
                        background: #fff;
                        border-bottom: 2px solid #fff;
                        color: #004085;
                        font-weight: bold;
                        position: relative;
                        z-index: 2;
                        margin-bottom: -2px;
                    }
                </style>
                <ul id="EscalatedActiveTicketTabs">
                    <li data-tab="hourly">
                        <a href="#hourly" onclick="switchTab('hourly'); return false;">
                            [% Translate("Hourly") | html %]
                        </a>
                    </li>
                    <li class="Active" data-tab="daily">
                        <a href="#daily" onclick="switchTab('daily'); return false;">
                            [% Translate("Daily") | html %]
                        </a>
                    </li>
                    <li data-tab="weekly">
                        <a href="#weekly" onclick="switchTab('weekly'); return false;">
                            [% Translate("Weekly") | html %]
                        </a>
                    </li>
                    <li data-tab="monthly">
                        <a href="#monthly" onclick="switchTab('monthly'); return false;">
                            [% Translate("Monthly") | html %]
                        </a>
                    </li>
                    <li data-tab="quarterly">
                        <a href="#quarterly" onclick="switchTab('quarterly'); return false;">
                            [% Translate("Quarterly") | html %]
                        </a>
                    </li>
                    <li data-tab="yearly">
                        <a href="#yearly" onclick="switchTab('yearly'); return false;">
                            [% Translate("Yearly") | html %]
                        </a>
                    </li>
                </ul>

                <!-- Filter Container (per-tab filters) -->
                <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 4px; border: 1px solid #dee2e6;">
                    <!-- Hourly Filter -->
                    <div id="hourlyFilter" class="tab-filter" style="display: none;">
                        <label style="font-weight: bold; margin-right: 10px;">[% Translate("Select Date") | html %]:</label>
                        <input type="date" id="hourlyDate" class="filter-input" style="padding: 6px 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px;">
                        <button type="button" onclick="applyFilter()" style="margin-left: 10px; padding: 6px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            [% Translate("Apply") | html %]
                        </button>
                    </div>

                    <!-- Daily Filter -->
                    <div id="dailyFilter" class="tab-filter" style="display: block;">
                        <label style="font-weight: bold; margin-right: 10px;">[% Translate("Select Week") | html %]:</label>
                        <select id="dailyWeek" class="filter-input" style="padding: 6px 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px;"></select>
                        <button type="button" onclick="applyFilter()" style="margin-left: 10px; padding: 6px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            [% Translate("Apply") | html %]
                        </button>
                    </div>

                    <!-- Weekly Filter -->
                    <div id="weeklyFilter" class="tab-filter" style="display: none;">
                        <label style="font-weight: bold; margin-right: 10px;">[% Translate("Month") | html %]:</label>
                        <select id="weeklyMonth" class="filter-input" style="padding: 6px 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; margin-right: 15px;">
                            <option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option><option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option><option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option>
                        </select>
                        <label style="font-weight: bold; margin-right: 10px;">[% Translate("Year") | html %]:</label>
                        <select id="weeklyYear" class="filter-input" style="padding: 6px 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px;"></select>
                        <button type="button" onclick="applyFilter()" style="margin-left: 10px; padding: 6px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            [% Translate("Apply") | html %]
                        </button>
                    </div>

                    <!-- Monthly Filter -->
                    <div id="monthlyFilter" class="tab-filter" style="display: none;">
                        <label style="font-weight: bold; margin-right: 10px;">[% Translate("Start Month") | html %]:</label>
                        <select id="monthlyStartMonth" class="filter-input" style="padding: 6px 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; margin-right: 15px;">
                            <option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option><option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option><option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option>
                        </select>
                        <label style="font-weight: bold; margin-right: 10px;">[% Translate("End Month") | html %]:</label>
                        <select id="monthlyEndMonth" class="filter-input" style="padding: 6px 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; margin-right: 15px;">
                            <option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option><option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option><option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12" selected>December</option>
                        </select>
                        <label style="font-weight: bold; margin-right: 10px;">[% Translate("Year") | html %]:</label>
                        <select id="monthlyYear" class="filter-input" style="padding: 6px 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px;"></select>
                        <button type="button" onclick="applyFilter()" style="margin-left: 10px; padding: 6px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            [% Translate("Apply") | html %]
                        </button>
                    </div>

                    <!-- Quarterly Filter -->
                    <div id="quarterlyFilter" class="tab-filter" style="display: none;">
                        <label style="font-weight: bold; margin-right: 10px;">[% Translate("Select Year") | html %]:</label>
                        <select id="quarterlyYear" class="filter-input" style="padding: 6px 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px;"></select>
                        <button type="button" onclick="applyFilter()" style="margin-left: 10px; padding: 6px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            [% Translate("Apply") | html %]
                        </button>
                    </div>

                    <!-- Yearly Filter -->
                    <div id="yearlyFilter" class="tab-filter" style="display: none;">
                        <label style="font-weight: bold; margin-right: 10px;">[% Translate("Start Year") | html %]:</label>
                        <select id="yearlyStartYear" class="filter-input" style="padding: 6px 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; margin-right: 15px;"></select>
                        <label style="font-weight: bold; margin-right: 10px;">[% Translate("End Year") | html %]:</label>
                        <select id="yearlyEndYear" class="filter-input" style="padding: 6px 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px;"></select>
                        <button type="button" onclick="applyFilter()" style="margin-left: 10px; padding: 6px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            [% Translate("Apply") | html %]
                        </button>
                    </div>

                    <span id="FilterLoadingIndicator" style="margin-left: 10px; display: none;">
                        <i class="fa fa-spinner fa-spin"></i> [% Translate("Loading...") | html %]
                    </span>
                </div>

                <!-- Chart Display Area -->
                <div id="chartDisplayArea" style="display: flex; gap: 20px;">
                    <div style="flex: 0 0 300px;">
                        <h3 id="chartTitle" style="background: #004085; color: white; padding: 10px; margin: 0; border-radius: 4px 4px 0 0;">
                            Escalated Active Tickets Breakdown
                        </h3>
                        <div id="dataTableContainer" style="overflow-x: auto;"></div>
                    </div>
                    <div style="flex: 1; border: 1px solid #dee2e6; padding: 20px; border-radius: 4px; background: white;">
                        <canvas id="mtrdBacklogChart" style="max-height: 450px;"></canvas>
                    </div>
                    <div style="flex: 0 0 180px;">
                        <h4 style="margin-top: 0;">[% Translate("Legend") | html %]</h4>
                        <div style="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
                            <div style="margin-bottom: 10px;"><div style="display: inline-block; width: 20px; height: 20px; background: #ff8c00; margin-right: 8px; vertical-align: middle;"></div><span>P1</span></div>
                            <div style="margin-bottom: 10px;"><div style="display: inline-block; width: 20px; height: 20px; background: #ffeb3b; margin-right: 8px; vertical-align: middle;"></div><span>P2</span></div>
                            <div style="margin-bottom: 10px;"><div style="display: inline-block; width: 20px; height: 20px; background: #4caf50; margin-right: 8px; vertical-align: middle;"></div><span>P3</span></div>
                            <div style="margin-bottom: 10px;"><div style="display: inline-block; width: 20px; height: 20px; background: #2196f3; margin-right: 8px; vertical-align: middle;"></div><span>P4</span></div>
                            <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd;"><div style="display: inline-block; width: 20px; height: 3px; background: #666; margin-right: 8px; vertical-align: middle; border: 1px dashed #666;"></div><span style="font-weight: bold; color: #666;">Priority Average</span></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script src="[% Config("Frontend::WebPath") %]js/Chart.min.js"></script>
<script type="text/javascript">
(function() {
    'use strict';
    let currentTab = 'daily';
    let chartInstance = null;

    function waitForChart() {
        if (typeof Chart !== 'undefined') { init(); } else { setTimeout(waitForChart, 100); }
    }
    if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', waitForChart); } else { waitForChart(); }

    function init() {
        populateYearDropdowns();
        populateWeekDropdown();
        setDefaultDate();
        loadTabData('daily');
    }

    window.switchTab = function(tabName) {
        document.querySelectorAll('#EscalatedActiveTicketTabs li').forEach(tab => {
            tab.classList.toggle('Active', tab.getAttribute('data-tab') === tabName);
        });
        document.querySelectorAll('.tab-filter').forEach(f => f.style.display = 'none');
        const filterMap = { 'hourly': 'hourlyFilter', 'daily': 'dailyFilter', 'weekly': 'weeklyFilter', 'monthly': 'monthlyFilter', 'quarterly': 'quarterlyFilter', 'yearly': 'yearlyFilter' };
        document.getElementById(filterMap[tabName]).style.display = 'block';
        currentTab = tabName;
        loadTabData(tabName);
        return false;
    };

    window.applyFilter = function() { loadTabData(currentTab); };

    function populateYearDropdowns() {
        const currentYear = new Date().getFullYear();
        const years = []; for (let i = 0; i < 5; i++) years.push(currentYear - i);
        ['weeklyYear', 'monthlyYear', 'quarterlyYear', 'yearlyStartYear', 'yearlyEndYear'].forEach(id => {
            const select = document.getElementById(id);
            if (select) { select.innerHTML = ''; years.forEach(y => { const o = document.createElement('option'); o.value = y; o.textContent = y; if ((id === 'yearlyStartYear' && y === currentYear - 1) || (id !== 'yearlyStartYear' && y === currentYear)) o.selected = true; select.appendChild(o); }); }
        });
    }

    function populateWeekDropdown() {
        const select = document.getElementById('dailyWeek'); if (!select) return;
        const currentDate = new Date(); select.innerHTML = '';
        for (let i = 0; i < 12; i++) {
            const weekStart = new Date(currentDate); weekStart.setDate(currentDate.getDate() - (i * 7));
            const dayOfWeek = weekStart.getDay(); const daysToMonday = (dayOfWeek === 0 ? 6 : dayOfWeek - 1);
            const monday = new Date(weekStart); monday.setDate(weekStart.getDate() - daysToMonday);
            const weekNum = getISOWeek(monday); const year = monday.getFullYear();
            const option = document.createElement('option');
            option.value = `${year}-W${String(weekNum).padStart(2, '0')}`;
            option.textContent = `Week ${String(weekNum).padStart(2, '0')} (${formatDate(monday)})`;
            if (i === 0) option.selected = true;
            select.appendChild(option);
        }
    }

    function getISOWeek(date) { const d = new Date(date); d.setHours(0, 0, 0, 0); d.setDate(d.getDate() + 4 - (d.getDay() || 7)); const yearStart = new Date(d.getFullYear(), 0, 1); return Math.ceil((((d - yearStart) / 86400000) + 1) / 7); }
    function formatDate(date) { const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']; return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`; }

    function setDefaultDate() {
        const dateInput = document.getElementById('hourlyDate'); if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];
        const monthSelect = document.getElementById('weeklyMonth'); if (monthSelect) monthSelect.value = new Date().getMonth() + 1;
        const startMonthSelect = document.getElementById('monthlyStartMonth'); if (startMonthSelect) startMonthSelect.value = 1;
        const endMonthSelect = document.getElementById('monthlyEndMonth'); if (endMonthSelect) endMonthSelect.value = new Date().getMonth() + 1;
    }

    function loadTabData(tabName) {
        const loadingIndicator = document.getElementById('FilterLoadingIndicator');
        if (loadingIndicator) loadingIndicator.style.display = 'inline';
        const params = { Action: 'AgentEscalatedActiveTicketBreakdown', Subaction: 'GetTabData', Tab: tabName };
        switch(tabName) {
            case 'hourly': params.Date = document.getElementById('hourlyDate').value; break;
            case 'daily': params.Week = document.getElementById('dailyWeek').value; break;
            case 'weekly': params.Month = document.getElementById('weeklyYear').value + '-' + String(document.getElementById('weeklyMonth').value).padStart(2, '0'); break;
            case 'monthly': params.StartMonth = document.getElementById('monthlyStartMonth').value; params.EndMonth = document.getElementById('monthlyEndMonth').value; params.Year = document.getElementById('monthlyYear').value; break;
            case 'quarterly': params.Year = document.getElementById('quarterlyYear').value; break;
            case 'yearly': params.StartYear = document.getElementById('yearlyStartYear').value; params.EndYear = document.getElementById('yearlyEndYear').value; break;
        }
        $.ajax({ url: '[% Env("Baselink") %]', type: 'POST', data: params, dataType: 'json',
            success: function(data) { if (data.Success) { renderChartAndTable(data.Data, tabName); } else { alert('Error: ' + (data.ErrorMessage || 'Unknown')); } },
            error: function(xhr, status, error) { alert('Error loading data: ' + status); },
            complete: function() { if (loadingIndicator) loadingIndicator.style.display = 'none'; }
        });
    }

    function renderChartAndTable(data, tabName) {
        const titleMap = { 'hourly': 'Breakdown [Hourly]', 'daily': 'Breakdown [Daily]', 'weekly': 'Breakdown [Weekly]', 'monthly': 'Breakdown [Monthly]', 'quarterly': 'Breakdown [Quarterly]', 'yearly': 'Breakdown [Yearly]' };
        document.getElementById('chartTitle').textContent = 'Escalated Active Tickets - ' + titleMap[tabName];
        renderDataTable(data, tabName);
        renderStackedBarChart(data, tabName);
    }

    function renderDataTable(data, tabName) {
        const container = document.getElementById('dataTableContainer'); if (!container) return;
        const labelMap = { 'hourly': 'Open Hour', 'daily': 'Open Date', 'weekly': 'Open Week', 'monthly': 'Open Month', 'quarterly': 'Open Quarter', 'yearly': 'Open Year' };
        function buildTicketLink(priority, startDate, endDate, count) {
            if (count === 0) return '0';
            const priorityMap = { 'P1': 'P1-Critical', 'P2': 'P2-High', 'P3': 'P3-Medium', 'P4': 'P4-Low' };
            const baseUrl = '[% Env("Baselink") %]Action=AgentEscalationReportTickets';
            const params = ['StateType=Open', 'Types=Incident', 'EscalatedOnly=1', 'Priorities=' + encodeURIComponent(priorityMap[priority] || priority), 'TicketCreateTimeNewerDate=' + encodeURIComponent(startDate), 'TicketCreateTimeOlderDate=' + encodeURIComponent(endDate), 'Source=AgentEscalatedActiveTicketBreakdown'];
            return `<a href="${baseUrl};${params.join(';')}" style="color: inherit; text-decoration: underline; font-weight: bold;">${count}</a>`;
        }
        function buildTicketLinkAll(startDate, endDate, count) {
            if (count === 0) return '0';
            const baseUrl = '[% Env("Baselink") %]Action=AgentEscalationReportTickets';
            const params = ['StateType=Open', 'Types=Incident', 'EscalatedOnly=1', 'TicketCreateTimeNewerDate=' + encodeURIComponent(startDate), 'TicketCreateTimeOlderDate=' + encodeURIComponent(endDate), 'Source=AgentEscalatedActiveTicketBreakdown'];
            return `<a href="${baseUrl};${params.join(';')}" style="color: inherit; text-decoration: underline; font-weight: bold;">${count}</a>`;
        }
        let html = '<table class="DataTable" style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #e3e8f4;"><th style="padding: 8px; text-align: left; border: 1px solid #dee2e6;">Count<br>' + labelMap[tabName] + '</th><th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; background: #ff8c00; color: white;">P1</th><th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; background: #ffeb3b;">P2</th><th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; background: #4caf50; color: white;">P3</th><th style="padding: 8px; text-align: center; border: 1px solid #dee2e6; background: #2196f3; color: white;">P4</th></tr></thead><tbody>';
        if (data.Rows && data.Rows.length > 0) { data.Rows.forEach(row => { html += '<tr><td style="padding: 8px; border: 1px solid #dee2e6;">' + row.Label + '</td><td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">' + buildTicketLink('P1', row.StartDate||'', row.EndDate||'', row.P1||0) + '</td><td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">' + buildTicketLink('P2', row.StartDate||'', row.EndDate||'', row.P2||0) + '</td><td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">' + buildTicketLink('P3', row.StartDate||'', row.EndDate||'', row.P3||0) + '</td><td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">' + buildTicketLink('P4', row.StartDate||'', row.EndDate||'', row.P4||0) + '</td></tr>'; }); }
        const gsd = data.GrandTotalStartDate || '', ged = data.GrandTotalEndDate || '';
        html += '<tr style="font-weight: bold; background: #d3d3d3;"><td style="padding: 8px; border: 1px solid #dee2e6;">Grand Total</td><td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">' + buildTicketLink('P1', gsd, ged, data.GrandTotal ? data.GrandTotal.P1 : 0) + '</td><td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">' + buildTicketLink('P2', gsd, ged, data.GrandTotal ? data.GrandTotal.P2 : 0) + '</td><td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">' + buildTicketLink('P3', gsd, ged, data.GrandTotal ? data.GrandTotal.P3 : 0) + '</td><td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">' + buildTicketLink('P4', gsd, ged, data.GrandTotal ? data.GrandTotal.P4 : 0) + '</td></tr></tbody></table>';
        const p1Total = data.GrandTotal ? parseFloat(data.GrandTotal.P1) : 0, p2Total = data.GrandTotal ? parseFloat(data.GrandTotal.P2) : 0, p3Total = data.GrandTotal ? parseFloat(data.GrandTotal.P3) : 0, p4Total = data.GrandTotal ? parseFloat(data.GrandTotal.P4) : 0;
        const p1Count = data.TicketCount ? data.TicketCount.P1 : 0, p2Count = data.TicketCount ? data.TicketCount.P2 : 0, p3Count = data.TicketCount ? data.TicketCount.P3 : 0, p4Count = data.TicketCount ? data.TicketCount.P4 : 0;
        const p1Avg = p1Count > 0 ? (p1Total / p1Count).toFixed(2) : 0, p2Avg = p2Count > 0 ? (p2Total / p2Count).toFixed(2) : 0, p3Avg = p3Count > 0 ? (p3Total / p3Count).toFixed(2) : 0, p4Avg = p4Count > 0 ? (p4Total / p4Count).toFixed(2) : 0;
        const totalAvg = (parseFloat(p1Avg) + parseFloat(p2Avg) + parseFloat(p3Avg) + parseFloat(p4Avg)) / 4, totalCount = p1Count + p2Count + p3Count + p4Count;
        // Summary table removed - now showing counts only, no hours/averages
        container.innerHTML = html;
    }

    function renderStackedBarChart(data, tabName) {
        const canvas = document.getElementById('mtrdBacklogChart'); if (!canvas) return;
        const ctx = canvas.getContext('2d');
        if (chartInstance) chartInstance.destroy();
        const labels = data.Rows ? data.Rows.map(r => r.Label) : [];
        const p1Data = data.Rows ? data.Rows.map(r => parseFloat(r.P1) || 0) : [];
        const p2Data = data.Rows ? data.Rows.map(r => parseFloat(r.P2) || 0) : [];
        const p3Data = data.Rows ? data.Rows.map(r => parseFloat(r.P3) || 0) : [];
        const p4Data = data.Rows ? data.Rows.map(r => parseFloat(r.P4) || 0) : [];
        const totals = data.Rows ? data.Rows.map(r => (parseFloat(r.P1)||0) + (parseFloat(r.P2)||0) + (parseFloat(r.P3)||0) + (parseFloat(r.P4)||0)) : [];
        const averageData = data.Rows ? data.Rows.map(r => ((parseFloat(r.P1)||0) + (parseFloat(r.P2)||0) + (parseFloat(r.P3)||0) + (parseFloat(r.P4)||0)) / 4) : [];
        const totalLabelPlugin = { id: 'totalLabel', afterDatasetsDraw: function(chart) { const ctx = chart.ctx; chart.data.datasets.forEach((ds, di) => { const meta = chart.getDatasetMeta(di); if (!meta.hidden && ds.type !== 'line' && ds.stack === 'tickets' && ds.label === 'P1') { meta.data.forEach((bar, i) => { const t = totals[i]; if (t > 0) { ctx.fillStyle = '#000'; ctx.font = 'bold 12px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'bottom'; ctx.fillText(t, bar.x, bar.y - 5); } }); } }); } };
        chartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [
            { label: 'P4', data: p4Data, backgroundColor: '#2196f3', borderColor: '#1976d2', borderWidth: 1, stack: 'tickets', order: 2 },
            { label: 'P3', data: p3Data, backgroundColor: '#4caf50', borderColor: '#388e3c', borderWidth: 1, stack: 'tickets', order: 2 },
            { label: 'P2', data: p2Data, backgroundColor: '#ffeb3b', borderColor: '#fbc02d', borderWidth: 1, stack: 'tickets', order: 2 },
            { label: 'P1', data: p1Data, backgroundColor: '#ff8c00', borderColor: '#e67e00', borderWidth: 1, stack: 'tickets', order: 2 },
            { label: 'Average', data: averageData, type: 'line', borderColor: '#666', backgroundColor: 'transparent', borderWidth: 4, borderDash: [10, 5], pointRadius: 7, pointBackgroundColor: '#666', pointBorderColor: '#fff', pointBorderWidth: 3, fill: false, tension: 0, order: 1, yAxisID: 'y' }
        ] }, plugins: [totalLabelPlugin], options: { responsive: true, maintainAspectRatio: true, layout: { padding: { top: 30 } }, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false, callbacks: { footer: function(items) { let sum = 0; items.forEach(i => { if (i.dataset.label !== 'Average') sum += i.parsed.y; }); return 'Total: ' + sum + ' tickets'; } } } }, scales: { x: { stacked: true, title: { display: true, text: getLabelMap(tabName) } }, y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Ticket Count' } } } } });
    }

    function getLabelMap(tabName) { const map = { 'hourly': 'Open Hour', 'daily': 'Open Date', 'weekly': 'Open Week', 'monthly': 'Open Month', 'quarterly': 'Open Quarter', 'yearly': 'Open Year' }; return map[tabName] || 'Time Period'; }
})();
</script>
