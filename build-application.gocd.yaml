# GoCD Pipeline for building Znuny 6.5 LTS with additional packages
#
# TEST PIPELINES - Remove "-test" suffix after verification
#
# Pipeline Architecture:
#   - znuny-develop-pipeline-test: develop-test branch → DEV server (auto-deploy)
#   - znuny-master-pipeline-test:  master-test branch → REF server (auto-deploy)
#
# Legacy Pipelines (ZNUNY-LEGACY group):
#   - znuny-cicd-pipeline-test: Old unified pipeline (paused, kept for rollback)
#   - znuny-build-pipeline, znuny-rel1.1-pipeline, znuny-rel2.0-pipeline: Deprecated
#
# Environment Variables Required (configure in GoCD UI: Admin → Environments → cicd-v2-test-env):
#   DEV_ZNUNY_HOST     - Proxmox host IP for DEV environment (e.g., 10.228.33.221)
#   REF_ZNUNY_HOST     - Proxmox host IP for REF environment (e.g., 10.228.33.223)
#   ZNUNY_CONTAINER_ID - LXC container ID running Znuny (e.g., 104)
#
# Deployment Architecture:
#   GoCD Agent → SSH ProxyJump → Proxmox Host → LXC Container
#   - Uses ProxyJump (not port forwarding) for defense-in-depth security
#   - Requires SSH keys on both Proxmox host AND container
#   - See: gocd/README.md for setup instructions
#
# Scripts:
#   - gocd/deploy-opm.sh      - Deploys OPM packages to Znuny (creates snapshot first)
#   - gocd/preflight-check.sh - Validates SSH connectivity before deployment

format_version: 10

environments:
  # Test environment for develop-test/master-test pipelines
  cicd-v2-test-env:
    pipelines:
      - znuny-develop-pipeline-test
      - znuny-master-pipeline-test
    agents:
      - 0b27be5b-bae0-4e63-ba34-ea80929a1cba

pipelines:
  # =============================================================================
  # DEVELOP-TEST BRANCH → DEV SERVER
  # Triggers: Automatically on push/merge to develop-test
  # Deploys: Automatically after preflight passes
  # =============================================================================
  znuny-develop-pipeline-test:
    group: ZNUNY
    label_template: "DEV-${COUNT}"

    materials:
      znuny-source:
        git: ssh://git@bitbucket.mot-solutions.com:7999/msstlite/msst-lite-znuny.git
        branch: develop-test
        destination: znuny-build
        auto_update: true

    stages:
      - build:
          clean_workspace: true
          approval:
            type: success
          jobs:
            build-and-package:
              timeout: 0
              artifacts:
                - build:
                    source: "**/*.opm"
                    destination: "pkg"
              tasks:
                - exec:
                    command: "bash"
                    arguments:
                      - "-c"
                      - |
                        echo "=== Build Info ==="
                        echo "Pipeline: ${GO_PIPELINE_NAME}"
                        echo "Build: ${GO_PIPELINE_COUNTER}"
                        echo "Branch: develop-test"
                        echo "Timestamp: $(date -Iseconds)"
                        echo "Agent: $(hostname)"
                        echo ""
                        echo "Checking for required build tools..."
                        perl -v

                - exec:
                    command: "/bin/sh"
                    arguments:
                      - "-c"
                      - |
                        ./znuny-build/gocd-build-application.sh /tmp/znuny-build-dir znuny-build

      - preflight:
          approval:
            type: success
            allow_only_on_success: true
          jobs:
            validate:
              tasks:
                - exec:
                    command: "/bin/bash"
                    arguments:
                      - "./znuny-build/gocd/preflight-check.sh"

      - deploy-dev:
          approval:
            type: success
            allow_only_on_success: true
          jobs:
            deploy:
              tasks:
                - fetch:
                    stage: build
                    job: build-and-package
                    source: pkg/
                    destination: packages/
                - exec:
                    command: "/bin/bash"
                    arguments:
                      - "-c"
                      - |
                        HOST="${DEV_ZNUNY_HOST:-NOT_CONFIGURED}"
                        CONTAINER_ID="${ZNUNY_CONTAINER_ID:-104}"
                        if [ "$HOST" = "NOT_CONFIGURED" ]; then
                          echo "ERROR: DEV_ZNUNY_HOST not configured"
                          exit 1
                        fi
                        ./znuny-build/gocd/deploy-opm.sh "$HOST" "DEV" "packages/pkg" "$CONTAINER_ID"

  # =============================================================================
  # MASTER-TEST BRANCH → REF SERVER
  # Triggers: Automatically on push/merge to master-test
  # Deploys: Automatically after preflight passes
  # =============================================================================
  znuny-master-pipeline-test:
    group: ZNUNY
    label_template: "REF-${COUNT}"

    materials:
      znuny-source:
        git: ssh://git@bitbucket.mot-solutions.com:7999/msstlite/msst-lite-znuny.git
        branch: master-test
        destination: znuny-build
        auto_update: true

    stages:
      - build:
          clean_workspace: true
          approval:
            type: success
          jobs:
            build-and-package:
              timeout: 0
              artifacts:
                - build:
                    source: "**/*.opm"
                    destination: "pkg"
              tasks:
                - exec:
                    command: "bash"
                    arguments:
                      - "-c"
                      - |
                        echo "=== Build Info ==="
                        echo "Pipeline: ${GO_PIPELINE_NAME}"
                        echo "Build: ${GO_PIPELINE_COUNTER}"
                        echo "Branch: master-test"
                        echo "Timestamp: $(date -Iseconds)"
                        echo "Agent: $(hostname)"
                        echo ""
                        echo "Checking for required build tools..."
                        perl -v

                - exec:
                    command: "/bin/sh"
                    arguments:
                      - "-c"
                      - |
                        ./znuny-build/gocd-build-application.sh /tmp/znuny-build-dir znuny-build

      - preflight:
          approval:
            type: success
            allow_only_on_success: true
          jobs:
            validate:
              tasks:
                - exec:
                    command: "/bin/bash"
                    arguments:
                      - "./znuny-build/gocd/preflight-check.sh"

      - deploy-ref:
          approval:
            type: success
            allow_only_on_success: true
          jobs:
            deploy:
              tasks:
                - fetch:
                    stage: build
                    job: build-and-package
                    source: pkg/
                    destination: packages/
                - exec:
                    command: "/bin/bash"
                    arguments:
                      - "-c"
                      - |
                        HOST="${REF_ZNUNY_HOST:-NOT_CONFIGURED}"
                        CONTAINER_ID="${ZNUNY_CONTAINER_ID:-104}"
                        if [ "$HOST" = "NOT_CONFIGURED" ]; then
                          echo "ERROR: REF_ZNUNY_HOST not configured"
                          exit 1
                        fi
                        ./znuny-build/gocd/deploy-opm.sh "$HOST" "REF" "packages/pkg" "$CONTAINER_ID"

  # =============================================================================
  # LEGACY PIPELINES
  # These are kept for rollback/reference purposes.
  # Pause these in GoCD UI after new pipelines are verified working.
  # =============================================================================
  znuny-cicd-pipeline-test:
    group: ZNUNY-LEGACY
    label_template: "LEGACY-${COUNT}"

    materials:
      znuny-source:
        git: ssh://git@bitbucket.mot-solutions.com:7999/msstlite/msst-lite-znuny.git
        branch: feature/CICD_TEST_RJ
        destination: znuny-build
        auto_update: true    # Disable or pause after new pipelines are verified

    stages:
      - build:
          clean_workspace: true
          approval:
            type: success
          jobs:
            build-and-package:
              timeout: 0
              artifacts:
                - build:
                    source: "**/*.opm"
                    destination: "pkg"
              tasks:
                - exec:
                    command: "bash"
                    arguments:
                      - "-c"
                      - |
                        echo "=== Build Info ==="
                        echo "Pipeline: ${GO_PIPELINE_NAME}"
                        echo "Build: ${GO_PIPELINE_COUNTER}"
                        echo "Branch: ${GO_MATERIAL_BRANCH_ZNUNY_SOURCE}"
                        echo "Timestamp: $(date -Iseconds)"
                        echo "Agent: $(hostname)"
                        echo ""
                        echo "Checking for required build tools..."
                        perl -v

                - exec:
                    command: "/bin/sh"
                    arguments:
                      - "-c"
                      - |
                        ./znuny-build/gocd-build-application.sh /tmp/znuny-build-dir znuny-build

      - preflight:
          approval:
            type: success
            allow_only_on_success: true
          jobs:
            validate:
              tasks:
                - exec:
                    command: "/bin/bash"
                    arguments:
                      - "./znuny-build/gocd/preflight-check.sh"

      - deploy-dev:
          approval:
            type: manual
            allow_only_on_success: true
          jobs:
            deploy:
              tasks:
                - fetch:
                    stage: build
                    job: build-and-package
                    source: pkg/
                    destination: packages/
                - exec:
                    command: "/bin/bash"
                    arguments:
                      - "-c"
                      - |
                        HOST="${DEV_ZNUNY_HOST:-NOT_CONFIGURED}"
                        CONTAINER_ID="${ZNUNY_CONTAINER_ID:-}"
                        if [ "$HOST" = "NOT_CONFIGURED" ]; then
                          echo "ERROR: DEV_ZNUNY_HOST not configured"
                          exit 1
                        fi
                        if [ -z "$CONTAINER_ID" ]; then
                          echo "WARNING: ZNUNY_CONTAINER_ID not configured - snapshots disabled"
                        fi
                        ./znuny-build/gocd/deploy-opm.sh "$HOST" "DEV" "packages/pkg" "$CONTAINER_ID"

      - deploy-ref:
          approval:
            type: manual
            allow_only_on_success: true
          jobs:
            deploy:
              tasks:
                - fetch:
                    stage: build
                    job: build-and-package
                    source: pkg/
                    destination: packages/
                - exec:
                    command: "/bin/bash"
                    arguments:
                      - "-c"
                      - |
                        HOST="${REF_ZNUNY_HOST:-NOT_CONFIGURED}"
                        CONTAINER_ID="${ZNUNY_CONTAINER_ID:-}"
                        if [ "$HOST" = "NOT_CONFIGURED" ]; then
                          echo "WARNING: REF_ZNUNY_HOST not configured, skipping"
                          exit 0
                        fi
                        if [ -z "$CONTAINER_ID" ]; then
                          echo "WARNING: ZNUNY_CONTAINER_ID not configured - snapshots disabled"
                        fi
                        ./znuny-build/gocd/deploy-opm.sh "$HOST" "REF" "packages/pkg" "$CONTAINER_ID"

# =============================================================================
# DEPRECATED LEGACY PIPELINES
# These pipelines are commented out and kept for historical reference only.
# They were replaced by the develop/master pipeline structure above.
# =============================================================================

#  znuny-build-pipeline:
#    group: ZNUNY-LEGACY
#    label_template: "LEGACY-BUILD-${COUNT}"
#    materials:
#      znuny-source:
#        git: ssh://git@bitbucket.mot-solutions.com:7999/msstlite/msst-lite-znuny.git
#        branch: master
#        destination: znuny-build
#        shallow_clone: true
#    stages:
#      - build:
#          clean_workspace: true
#          jobs:
#            build-and-package:
#              timeout: 0
#              artifacts:
#                - build:
#                    source: "**/*.opm"
#                    destination: "pkg"
#              tasks:
#                - exec:
#                    command: "bash"
#                    arguments:
#                      - "-c"
#                      - |
#                        echo "Checking for required build tools..."
#                        perl -v
#                - exec:
#                    command: "/bin/sh"
#                    arguments:
#                      - "-c"
#                      - |
#                        ./znuny-build/gocd-build-application.sh /tmp/znuny-build-dir znuny-build

#  znuny-rel1.1-pipeline:
#    group: ZNUNY-LEGACY
#    label_template: "LEGACY-R1.1-${COUNT}"
#    materials:
#      znuny-source:
#        git: ssh://git@bitbucket.mot-solutions.com:7999/msstlite/msst-lite-znuny.git
#        branch: R1.1
#        destination: znuny-1.1-build
#        shallow_clone: true
#    stages:
#      - build:
#          clean_workspace: true
#          jobs:
#            build-and-package:
#              timeout: 0
#              artifacts:
#                - build:
#                    source: "**/*.opm"
#                    destination: "pkg"
#              tasks:
#                - exec:
#                    command: "bash"
#                    arguments:
#                      - "-c"
#                      - |
#                        echo "Checking for required build tools..."
#                        perl -v
#                - exec:
#                    command: "/bin/sh"
#                    arguments:
#                      - "-c"
#                      - |
#                        ./znuny-1.1-build/gocd-build-application.sh /tmp/znuny-1.1-build-dir znuny-1.1-build

#  znuny-rel2.0-pipeline:
#    group: ZNUNY-LEGACY
#    label_template: "LEGACY-R2.0-${COUNT}"
#    materials:
#      znuny-source:
#        git: ssh://git@bitbucket.mot-solutions.com:7999/msstlite/msst-lite-znuny.git
#        branch: R2.0
#        destination: znuny-2.0-build
#        shallow_clone: true
#    stages:
#      - build:
#          clean_workspace: true
#          jobs:
#            build-and-package:
#              timeout: 0
#              artifacts:
#                - build:
#                    source: "**/*.opm"
#                    destination: "pkg"
#              tasks:
#                - exec:
#                    command: "bash"
#                    arguments:
#                      - "-c"
#                      - |
#                        echo "Checking for required build tools..."
#                        perl -v
#                - exec:
#                    command: "/bin/sh"
#                    arguments:
#                      - "-c"
#                      - |
#                        ./znuny-2.0-build/gocd-build-application.sh /tmp/znuny-2.0-build-dir znuny-2.0-build
